// --- YENİLENMİŞ ÖDEME FONKSİYONU ---
async function completeOrder() {
    if(sepet.length === 0) { alert("Sepet boş!"); return; }
    
    // Müşteri bilgilerini al
    const musteri = { 
        ad: document.getElementById('ad').value, 
        soyad: document.getElementById('soyad').value, 
        tel: document.getElementById('tel').value, 
        adres: document.getElementById('adres').value,
        il: document.getElementById('il').value,
        email: document.getElementById('email').value 
    };

    // Basit doğrulama
    if(!musteri.ad || !musteri.tel || !musteri.adres || !musteri.email) { 
        alert("Lütfen tüm adres ve iletişim bilgilerini doldurun."); return; 
    }

    // Butonu kilitle
    const btn = document.querySelector('.btn-pay');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ödeme Sayfası Hazırlanıyor...'; 
    btn.disabled = true;

    // Toplam tutarı sayıya çevir
    const toplamTutar = parseFloat(finalTotalEl.innerText.replace('TL','').replace('.','').replace(',','.'));

    try {
        // 1. Adım: Sunucudan ödeme başlatmasını iste
        const response = await fetch('/api/odeme-baslat', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ musteri, sepet, toplamTutar }) 
        });

        const data = await response.json();

        // 2. Adım: Iyzico başarılıysa formu göster
        if (data.status === 'success') {
            // Sepeti temizle (veya ödeme başarılı olunca temizle)
            // localStorage.removeItem('pomelitaSepet'); 
            
            // Sayfanın içeriğini Iyzico formuyla değiştir veya yönlendir
            document.body.innerHTML = data.htmlContent; 
            
            // Eğer Iyzico scripti çalışmazsa (HTML içinde gelirse) manuel tetikle
            // Genellikle Iyzico formu bir script tagi içerir, tarayıcı bunu çalıştırmayabilir.
            // Bu yüzden en garantisi sunucudan gelen linke yönlendirmektir ama Iyzico form içeriği gönderir.
            // Form içeriğindeki scriptleri çalıştırmak için:
            const scripts = document.body.getElementsByTagName("script");
            for (let i = 0; i < scripts.length; i++) {
                eval(scripts[i].innerText);
            }

        } else {
            alert("Ödeme Başlatılamadı: " + data.message);
            btn.innerHTML = originalText; 
            btn.disabled = false;
        }

    } catch(e) { 
        console.error(e);
        alert("Sunucu hatası."); 
        btn.innerHTML = originalText; 
        btn.disabled = false; 
    }
}